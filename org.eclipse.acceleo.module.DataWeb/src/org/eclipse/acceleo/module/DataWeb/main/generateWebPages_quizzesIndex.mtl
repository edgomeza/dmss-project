[comment encoding = UTF-8 /]
[module generateWebPages_quizzesIndex('http://www.unex.es/dmss/dataweb')]

[template public generateQuizzesIndex(app : Aplicacion)]
[file ('web/quizzes/index.html', false, 'UTF-8')]
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[app.nombre/] - Cuestionarios</title>
    <meta name="description" content="Lista de cuestionarios disponibles">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="../assets/icons/favicon.ico">
</head>
<body>
    <header class="app-header">
        <div class="container">
            <h1>Cuestionarios de Evaluación</h1>
            <p>Pon a prueba tus conocimientos con nuestros cuestionarios asignados a tu rol</p>
        </div>
    </header>
    
    <nav class="main-nav">
        <div class="container nav-container">
            <div class="nav-brand">
                <a href="../index.html" class="nav-logo">[app.nombre/]</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="../index.html" class="nav-link">Inicio</a>
                </li>
                [if (not app.encuestas->isEmpty())]
                <li class="nav-item">
                    <a href="../surveys/index.html" class="nav-link">Encuestas</a>
                </li>
                [/if]
                <li class="nav-item">
                    <a href="index.html" class="nav-link active">Cuestionarios</a>
                </li>
            </ul>
            <button class="nav-toggle" aria-label="Abrir menú">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>
    
    <main class="main-content">
        <div class="container">
            <!-- Mensaje de rol -->
            <div class="role-message alert alert-info mb-6">
                <strong>Nota:</strong> Los cuestionarios que se muestran a continuación son los que están asignados a tu rol actual. Cada rol tiene acceso a diferentes evaluaciones según su configuración.
            </div>
            
            <!-- Contenedor de cuestionarios -->
            <div id="quizzes-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Cargando cuestionarios para tu rol...</span>
                </div>
            </div>
            
            <!-- Resultados de cuestionarios -->
            <section class="quiz-results mt-8" id="quiz-results-section" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h2>Tus Resultados de Evaluaciones</h2>
                    </div>
                    <div class="card-body">
                        <div id="quiz-results-container">
                            <p class="loading-message">Cargando tus resultados...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <footer class="app-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 [app.nombre/]. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
    
    <script src="../assets/js/app.js"></script>
    
    <script>
		async function loadQuizResults() {
		    try {
		        const resultsSection = document.getElementById('quiz-results-section');
		        if (!resultsSection) {
		            console.log('Quiz results section not found');
		            return;
		        }
		        
		        const currentUserId = 'usuario@example.com'; // En una implementación real, se obtendría de la sesión
		        
		        // Usar la base de datos ya conectada o intentar conectar
		        let db = window.localDB;
		        if (!db) {
		            console.log('Database not available, trying to connect...');
		            try {
		                db = await initDatabase();
		            } catch (error) {
		                console.warn('Could not connect to database for results:', error);
		                resultsSection.style.display = 'none';
		                return;
		            }
		        }
		        
		        // Buscar resultados confirmados
		        let allResults = ['['/]];
		        try {
		            allResults = await db.getAll('RESPUESTAS_CUESTIONARIO');
		            console.log('All quiz results found:', allResults.length);
		        } catch (error) {
		            console.warn('Error getting quiz results:', error);
		            resultsSection.style.display = 'none';
		            return;
		        }
		        
		        // Filtrar resultados del usuario actual
		        const userResults = allResults.filter(r => r.userId === currentUserId);
		        const confirmedResults = userResults.filter(r => r.results && r.results.gradeConfirmed);
		        
		        console.log(`User results: ${userResults.length}, Confirmed: ${confirmedResults.length}`);
		        
		        if (confirmedResults.length === 0) {
		            resultsSection.innerHTML = `
		                <div class="card">
		                    <div class="card-header">
		                        <h2>Tus Resultados de Evaluaciones</h2>
		                    </div>
		                    <div class="card-body">
		                        <div class="empty-state text-center">
		                            <div class="empty-icon mb-3">
		                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
		                                    <path d="M9 11l3 3L22 4"></path>
		                                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
		                                </svg>
		                            </div>
		                            <p class="text-muted">Aún no tienes evaluaciones calificadas por un administrador.</p>
		                            <small class="text-muted">Una vez que completes cuestionarios y sean revisados, aparecerán aquí.</small>
		                        </div>
		                        <div class="text-center mt-4">
		                            <a href="results.html" class="btn btn-primary">Ver página de resultados</a>
		                        </div>
		                    </div>
		                </div>
		            `;
		        } else {
		            resultsSection.innerHTML = `
		                <div class="card">
		                    <div class="card-header">
		                        <h2>Tus Resultados de Evaluaciones</h2>
		                    </div>
		                    <div class="card-body">
		                        <div class="text-center">
		                            <div class="results-summary mb-3">
		                                <div class="summary-item">
		                                    <span class="summary-number">${confirmedResults.length}</span>
		                                    <span class="summary-label">Evaluaciones Calificadas</span>
		                                </div>
		                            </div>
		                            <p class="text-muted mb-4">Tienes ${confirmedResults.length} evaluaciones calificadas por un administrador.</p>
		                            <a href="results.html" class="btn btn-primary">Ver todos mis resultados</a>
		                        </div>
		                    </div>
		                </div>
		            `;
		        }
		        
		        resultsSection.style.display = 'block';
		    } catch (error) {
		        console.error('Error loading quiz results:', error);
		        const resultsSection = document.getElementById('quiz-results-section');
		        if (resultsSection) {
		            resultsSection.style.display = 'none';
		        }
		    }
		}
		
		// Función auxiliar mejorada para inicializar la base de datos
		async function initDatabase() {
		    if (window.localDB && window.localDB.db) {
		        return window.localDB;
		    }
		    
		    return new Promise((resolve, reject) => {
		        const request = indexedDB.open('DataWeb_DB', 2);
		        
		        request.onsuccess = () => {
		            const database = request.result;
		            const dbWrapper = {
		                db: database,
		                async getAll(storeName) {
		                    return new Promise((resolve, reject) => {
		                        if (!database.objectStoreNames.contains(storeName)) {
		                            console.warn(`Store "${storeName}" does not exist`);
		                            resolve(['['/]]);
		                            return;
		                        }
		                        const transaction = database.transaction(['['/]storeName], 'readonly');
		                        const store = transaction.objectStore(storeName);
		                        const request = store.getAll();
		                        request.onsuccess = () => resolve(request.result || ['['/]]);
		                        request.onerror = () => {
		                            console.error('Error reading from store:', request.error);
		                            resolve(['['/]]);
		                        };
		                    });
		                }
		            };
		            window.localDB = dbWrapper;
		            resolve(dbWrapper);
		        };
		        
		        request.onerror = () => {
		            console.error('Database connection failed:', request.error);
		            resolve(null);
		        };
		    });
		}
        // Cargar cuestionarios según el rol
        document.addEventListener('DOMContentLoaded', async () => {
		    try {
				async function initDatabase() {
				    if (window.localDB && window.localDB.db) {
				        return window.localDB;
				    }
				    
				    return new Promise((resolve, reject) => {
				        const request = indexedDB.open('DataWeb_DB', 2);
				        
				        request.onsuccess = () => {
				            const database = request.result;
				            const dbWrapper = {
				                db: database,
				                async getAll(storeName) {
				                    return new Promise((resolve, reject) => {
				                        if (!database.objectStoreNames.contains(storeName)) {
				                            resolve(['['/]]);
				                            return;
				                        }
				                        const transaction = database.transaction(['['/]storeName], 'readonly');
				                        const store = transaction.objectStore(storeName);
				                        const request = store.getAll();
				                        request.onsuccess = () => resolve(request.result);
				                        request.onerror = () => resolve(['['/]]);
				                    });
				                }
				            };
				            window.localDB = dbWrapper;
				            resolve(dbWrapper);
				        };
				        
				        request.onerror = () => resolve(null);
				    });
				}
				
		        const container = document.getElementById('quizzes-container');
		        if (!container) {
		            console.error('Quizzes container not found');
		            return;
		        }
		        
		        // Mostrar loading
		        container.innerHTML = `
		            <div class="loading text-center">
		                <div class="loading-spinner"></div>
		                <span>Cargando cuestionarios para tu rol...</span>
		            </div>
		        `;
		        
		        // Esperar a que la base de datos esté disponible
		        let db = null;
		        let attempts = 0;
		        const maxAttempts = 100; // 10 segundos máximo
		        
		        while (!db && attempts < maxAttempts) {
		            if (window.localDB && window.localDB.db) {
		                db = window.localDB;
		                break;
		            }
		            
		            // Intentar inicializar la base de datos
		            try {
		                const request = indexedDB.open('DataWeb_DB', 2);
		                db = await new Promise((resolve, reject) => {
		                    request.onsuccess = () => {
		                        const database = request.result;
		                        const dbWrapper = {
		                            db: database,
		                            async getAll(storeName) {
		                                return new Promise((resolve, reject) => {
		                                    if (!database.objectStoreNames.contains(storeName)) {
		                                        resolve(['['/]]);
		                                        return;
		                                    }
		                                    const transaction = database.transaction(['['/]storeName], 'readonly');
		                                    const store = transaction.objectStore(storeName);
		                                    const request = store.getAll();
		                                    request.onsuccess = () => resolve(request.result);
		                                    request.onerror = () => resolve(['['/]]);
		                                });
		                            }
		                        };
		                        window.localDB = dbWrapper;
		                        resolve(dbWrapper);
		                    };
		                    request.onerror = () => resolve(null);
		                });
		                break;
		            } catch (error) {
		                console.warn('Database initialization attempt failed:', error);
		            }
		            
		            await new Promise(resolve => setTimeout(resolve, 100));
		            attempts++;
		        }
		        
		        if (!db) {
		            throw new Error('No se pudo conectar con la base de datos después de varios intentos');
		        }
		        
		        console.log('Base de datos conectada correctamente');
		        
		        // Cargar cuestionarios desde la base de datos
		        const allQuizzes = await db.getAll('CUESTIONARIOS');
		        console.log('Cuestionarios cargados desde BD:', allQuizzes);
		        
		        // Determinar rol actual
		        const currentRole = localStorage.getItem('current_role') || 'Usuario';
		        console.log('Rol actual:', currentRole);
		        
		        // Obtener asignaciones de roles
		        const roleAssignments = JSON.parse(localStorage.getItem('quiz_role_assignments') || '{}');
		        console.log('Asignaciones de roles:', roleAssignments);
		        
		        // Convertir formato de base de datos a formato esperado
		        let availableQuizzes = allQuizzes.map(quiz => ({
		            name: quiz.nombre,
		            title: quiz.titulo,
		            description: quiz.descripcion || `Cuestionario: ${quiz.titulo}`,
		            questions: 0, // Se puede calcular posteriormente si es necesario
		            timeLimit: quiz.tiempoLimite || 30
		        }));

				function openQuizPage(quizName) {
				    // Primero, intentar abrir la página generada dinámicamente
				    if (window.pageGenerator) {
				        const quizHTML = window.pageGenerator.getQuizPage(quizName);
				        if (quizHTML) {
				            const newWindow = window.open('', '_blank');
				            newWindow.document.write(quizHTML);
				            newWindow.document.close();
				            return;
				        }
				    }
				    
				    // Si no hay página generada, intentar redirigir al archivo HTML
				    const quizURL = `${quizName}.html`;
				    
				    // Verificar si el archivo existe
				    fetch(quizURL, { method: 'HEAD' })
				        .then(response => {
				            if (response.ok) {
				                // El archivo existe, redirigir
				                window.location.href = quizURL;
				            } else {
				                // El archivo no existe, mostrar mensaje
				                alert('Cuestionario no disponible. La página se está generando, por favor intenta de nuevo en unos momentos.');
				            }
				        })
				        .catch(() => {
				            // Error en la verificación, intentar abrir de todos modos
				            window.open(quizURL, '_blank');
				        });
				}

				async function loadQuizResults() {
				    try {
				        const resultsSection = document.getElementById('quiz-results-section');
				        if (!resultsSection) return;
				        
				        const currentUserId = 'usuario@example.com'; // En una implementación real, se obtendría de la sesión
				        
				        // Usar la base de datos ya conectada
				        const db = window.localDB;
				        if (!db) {
				            console.warn('Base de datos no disponible para cargar resultados');
				            resultsSection.style.display = 'none';
				            return;
				        }
				        
				        // Buscar resultados confirmados
				        let allResults = ['['/]];
				        try {
				            allResults = await db.getAll('RESPUESTAS_CUESTIONARIO');
				        } catch (error) {
				            console.warn('Error al obtener resultados de cuestionarios:', error);
				            resultsSection.style.display = 'none';
				            return;
				        }
				        
				        const userResults = allResults.filter(r => r.userId === currentUserId);
				        const confirmedResults = userResults.filter(r => r.results && r.results.gradeConfirmed);
				        
				        if (confirmedResults.length === 0) {
				            resultsSection.innerHTML = `
				                <div class="card">
				                    <div class="card-header">
				                        <h2>Tus Resultados de Evaluaciones</h2>
				                    </div>
				                    <div class="card-body">
				                        <div class="empty-state">
				                            <p>Aún no tienes evaluaciones calificadas por un administrador.</p>
				                        </div>
				                        <div class="text-center mt-4">
				                            <a href="results.html" class="btn btn-primary">Ver página de resultados</a>
				                        </div>
				                    </div>
				                </div>
				            `;
				        } else {
				            resultsSection.innerHTML = `
				                <div class="card">
				                    <div class="card-header">
				                        <h2>Tus Resultados de Evaluaciones</h2>
				                    </div>
				                    <div class="card-body">
				                        <p>Tienes ${confirmedResults.length} evaluaciones calificadas por un administrador.</p>
				                        <div class="text-center mt-4">
				                            <a href="results.html" class="btn btn-primary">Ver todos mis resultados</a>
				                        </div>
				                    </div>
				                </div>
				            `;
				        }
				        
				        resultsSection.style.display = 'block';
				    } catch (error) {
				        console.error('Error loading quiz results:', error);
				        const resultsSection = document.getElementById('quiz-results-section');
				        if (resultsSection) {
				            resultsSection.style.display = 'none';
				        }
				    }
				}
		        
		        // Filtrar por rol si hay asignaciones
		        if (Object.keys(roleAssignments).length > 0) {
		            availableQuizzes = availableQuizzes.filter(quiz => {
		                if (roleAssignments['['/]quiz.name] && roleAssignments['['/]quiz.name].includes(currentRole)) {
		                    return true;
		                }
		                return !roleAssignments['['/]quiz.name]; // Si no hay asignación, mostrar
		            });
		        }
		        
		        console.log('Cuestionarios disponibles para el rol:', availableQuizzes);
		        
		        // Mostrar cuestionarios
		        if (availableQuizzes.length === 0) {
		            container.innerHTML = `
		                <div class="empty-state">
		                    <div class="empty-icon">
		                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
		                            <circle cx="12" cy="12" r="10"></circle>
		                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
		                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
		                        </svg>
		                    </div>
		                    <h3>No hay cuestionarios disponibles para tu rol</h3>
		                    <p>No se han asignado cuestionarios al rol "${currentRole}" o no hay cuestionarios activos en este momento.</p>
		                    <a href="../index.html" class="btn btn-primary">Volver al inicio</a>
		                </div>
		            `;
		        } else {
		            container.innerHTML = `
		                <div class="quizzes-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
		                    ${availableQuizzes.map(quiz => `
		                        <div class="quiz-card card animate-target">
		                            <div class="card-header">
		                                <h3>${quiz.title}</h3>
		                            </div>
		                            <div class="card-body">
		                                <p>${quiz.description}</p>
		                                <div class="quiz-info">
		                                    <span class="badge badge-primary">Evaluativo</span>
		                                    <span class="badge badge-warning">${quiz.timeLimit} minutos</span>
		                                </div>
		                            </div>
		                            <div class="card-footer">
		                                <button class="btn btn-primary btn-block" onclick="openQuizPage('${quiz.name}')">
		                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
		                                        <circle cx="12" cy="12" r="10"></circle>
		                                        <path d="m9 12 2 2 4-4"></path>
		                                    </svg>
		                                    Realizar Cuestionario
		                                </button>
		                            </div>
		                        </div>
		                    `).join('')}
		                </div>
		            `;
		        }
		        
		        // Cargar resultados de cuestionarios
		        await loadQuizResults();
		        
		    } catch (error) {
		        console.error('Error cargando cuestionarios:', error);
		        const container = document.getElementById('quizzes-container');
		        if (container) {
		            container.innerHTML = `
		                <div class="error-message">
		                    <p>Error al cargar los cuestionarios: ${error.message}</p>
		                    <button onclick="location.reload()" class="btn btn-primary">Reintentar</button>
		                </div>
		            `;
		        }
		    }
		});

		window.openQuizPage = function(quizName) {
		    const quizHTML = localStorage.getItem(`quiz_page_${quizName}`);
		    if (quizHTML) {
		        const newWindow = window.open('', '_blank');
		        newWindow.document.write(quizHTML);
		        newWindow.document.close();
		    } else {
		        alert('Cuestionario no disponible. Por favor, contacte al administrador.');
		    }
		};
		
		window.loadQuizResults = loadQuizResults;
		window.initDatabase = initDatabase;
    </script>
    
    <style>
        .quizzes-grid {
            margin-top: 2rem;
        }
        
        .quiz-card {
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }
        
        .quiz-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .quiz-info {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .badge-warning {
            background: var(--warning-100);
            color: var(--warning-700);
        }
        
        .badge-primary {
            background: var(--primary-100);
            color: var(--primary-700);
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .empty-icon {
            margin: 0 auto 2rem;
            color: var(--gray-400);
        }
        
        .empty-state h3 {
            margin-bottom: 1rem;
            color: var(--gray-700);
        }
        
        .empty-state p {
            color: var(--gray-500);
            margin-bottom: 2rem;
        }
        
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--gray-200);
            border-radius: 50%;
            border-top-color: var(--primary-500);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-message {
            text-align: center;
            color: var(--gray-600);
            padding: 2rem;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--danger-600);
            background: var(--danger-50);
            border-radius: var(--radius);
            border: 1px solid var(--danger-200);
        }
        
        /* Estilos para los resultados */
        .results-grid {
            margin-top: 1.5rem;
        }
        
        .result-card {
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .result-header {
            padding: 1rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-title {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .result-score {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            font-weight: 700;
        }
        
        .result-details {
            padding: 1rem;
        }
        
        .result-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .result-stat {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .result-value {
            font-weight: 500;
            color: var(--gray-900);
        }
        
        .pending-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0;
        }
        
        .pending-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }
        
        .pending-name {
            font-weight: 500;
            color: var(--gray-800);
        }
        
        .pending-date {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .no-results {
            text-align: center;
            padding: 2rem;
            color: var(--gray-600);
            font-style: italic;
        }
    </style>
</body>
</html>
[/file]
[/template]