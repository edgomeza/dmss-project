[comment encoding = UTF-8 /]
[module generateWebPages_crudDetail('http://www.unex.es/dmss/dataweb')]

[template public generateCRUDDetail(app : Aplicacion, entidad : Entidad, rol : Rol)]
[file ('web/'+rol.nombre.toLowerCase()+'/pages/'+entidad.nombre.toLowerCase()+'/detail.html', false, 'UTF-8')]
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[app.nombre/] - Detalles de [entidad.nombre/]</title>
    <meta name="description" content="Información detallada del registro de [entidad.nombre/]">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../../assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="../../../assets/icons/favicon.ico">
</head>
<body>
    <header class="app-header">
        <div class="container">
            <h1>Detalles de [entidad.nombre/]</h1>
            <p>Información completa del registro</p>
        </div>
    </header>
    
    <nav class="main-nav">
        <div class="container nav-container">
            <div class="nav-brand">
                <a href="../../../index.html" class="nav-logo">[app.nombre/]</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="../../dashboard.html" class="nav-link">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="index.html" class="nav-link">Gestión [entidad.nombre/]</a>
                </li>
                <li class="nav-item">
                    <a href="list.html" class="nav-link">Listar</a>
                </li>
                <li class="nav-item">
                    <a href="create.html" class="nav-link">Crear</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link active">Detalles</a>
                </li>
            </ul>
            <button class="nav-toggle" aria-label="Abrir menú">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>
    
    <nav class="breadcrumb">
        <div class="container">
            <ul class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="../../../index.html" class="breadcrumb-link">Inicio</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html" class="breadcrumb-link">[rol.nombre/]</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html" class="breadcrumb-link">[entidad.nombre/]</a>
                </li>
                <li class="breadcrumb-item">
                    <span>Detalles</span>
                </li>
            </ul>
        </div>
    </nav>
    
    <main class="main-content">
        <div class="container">
            <!-- Loading indicator -->
            <div id="loadingDetails" class="loading-indicator">
                <div class="loading-spinner"></div>
                <span>Cargando información...</span>
            </div>
            
            <!-- Contenido principal -->
            <div id="detailContent" style="display: none;">
                <!-- Acciones principales -->
                <section class="detail-actions mb-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="actions-row">
                                <div class="actions-info">
                                    <h2 id="entityTitle">[entidad.nombre/]</h2>
                                    <p class="text-muted">Información detallada del registro</p>
                                </div>
                                <div class="actions-buttons">
                                    <a href="edit.html" id="editLink" class="btn btn-warning">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Editar
                                    </a>
                                    <button class="btn btn-danger" onclick="confirmDelete()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        Eliminar
                                    </button>
                                    <a href="list.html" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="15,18 9,12 15,6"></polyline>
                                        </svg>
                                        Volver a la Lista
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Información básica -->
                <section class="basic-info mb-6">
                    <div class="card">
                        <div class="card-header">
                            <h3>Información Básica</h3>
                        </div>
                        <div class="card-body">
                            <div class="details-grid">
                                [for (atrib : Atributo | entidad.atributos)]
                                <div class="detail-item">
                                    <div class="detail-label">[atrib.nombre/]:</div>
                                    <div class="detail-value" id="field_[atrib.nombre/]">
                                        [if (atrib.isPrimaryKey)]
                                        <span class="badge badge-primary">ID</span>
                                        [else]
                                        -
                                        [/if]
                                    </div>
                                </div>
                                [/for]
                            </div>
                        </div>
                    </div>
                </section>
                
                [if (not entidad.referencias->isEmpty())]
                <!-- Referencias -->
                <section class="references-info mb-6">
                    <div class="card">
                        <div class="card-header">
                            <h3>Referencias</h3>
                        </div>
                        <div class="card-body">
                            <div class="references-grid">
                                [for (ref : Referencia | entidad.referencias)]
                                <div class="reference-item">
                                    <div class="reference-label">[ref.nombre/]:</div>
                                    <div class="reference-value" id="ref_[ref.nombre/]">
                                        <span class="badge badge-info">Cargando...</span>
                                    </div>
                                </div>
                                [/for]
                            </div>
                        </div>
                    </div>
                </section>
                [/if]
                
                <!-- Metadatos -->
                <section class="metadata-info">
                    <div class="card">
                        <div class="card-header">
                            <h3>Información del Sistema</h3>
                        </div>
                        <div class="card-body">
                            <div class="metadata-grid">
                                <div class="metadata-item">
                                    <div class="metadata-label">ID del Registro:</div>
                                    <div class="metadata-value" id="recordId">-</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">Tabla de Base de Datos:</div>
                                    <div class="metadata-value">[entidad.tableName/]</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">Entidad:</div>
                                    <div class="metadata-value">[entidad.nombre/]</div>
                                </div>
                                <div class="metadata-item">
                                    <div class="metadata-label">Última Entidad:</div>
									<div class="metadata-value" id="lastUpdated">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>
    
    <!-- Modal de confirmación de eliminación -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Confirmar Eliminación</h4>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar este registro de [entidad.nombre/]? Esta acción no se puede deshacer.</p>
                <div class="warning-box">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <span>Esta operación es irreversible</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>
    
    <footer class="app-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 [app.nombre/] - Detalles de [entidad.nombre/]</p>
            </div>
        </div>
    </footer>
    
    <script src="../../../assets/js/app.js"></script>
    <script src="../../../assets/js/data-manager.js"></script>
	<script src="../../../assets/js/crud-manager.js"></script>
    <script src="../../../assets/js/[entidad.nombre.toLowerCase()/].js"></script>
    
    <script>
	// Configuración específica para esta página
	window.entityConfig = {
	    name: '[entidad.nombre.toLowerCase()/]',
	    primaryKey: '[entidad.atributos->select(a | a.isPrimaryKey)->first().nombre/]'
	};
	
	let currentEntityId = null;
	let currentEntityData = null;
	
	// Función para cargar los detalles de la entidad
	async function loadEntityDetails() {
	    try {
	        const dataManager = new DataManager('[entidad.nombre.toLowerCase()/]');
	        const response = await dataManager.getById(currentEntityId);
	        
	        if (response && response.entity) {
	            currentEntityData = response.entity;
	            displayEntityDetails(response.entity, response.relations || {});
	            
	            document.getElementById('loadingDetails').style.display = 'none';
	            document.getElementById('detailContent').style.display = 'block';
	        } else {
	            // Si no existe, crear datos de ejemplo
	            const db = await dataManager.ensureDatabase();
	            
	            // Crear datos de ejemplo
	            for (let i = 1; i <= 5; i++) {
	                const sampleData = {
	                    [for (atrib : Atributo | entidad.atributos->select(a | not a.isPrimaryKey)) separator(',\n                    ')]
	                    [atrib.nombre/]: [if (atrib.tipo = TipoAtributo::BOOLEAN)](i % 2 === 0)[elseif (atrib.tipo = TipoAtributo::INTEGER)](i * 10)[elseif (atrib.tipo = TipoAtributo::DECIMAL)](i * 10.5)[else]'[entidad.nombre/] ' + i[/if]
	                    [/for]
	                };
	                await dataManager.create(sampleData);
	            }
	            
	            // Intentar cargar de nuevo
	            const retryResponse = await dataManager.getById(currentEntityId);
	            if (retryResponse && retryResponse.entity) {
	                currentEntityData = retryResponse.entity;
	                displayEntityDetails(retryResponse.entity, retryResponse.relations || {});
	                document.getElementById('loadingDetails').style.display = 'none';
	                document.getElementById('detailContent').style.display = 'block';
	            } else {
	                if (window.app && window.app.showAlert) {
	                    window.app.showAlert('Error: Registro no encontrado', 'danger');
	                }
	                setTimeout(() => {
	                    window.location.href = 'list.html';
	                }, 2000);
	            }
	        }
	    } catch (error) {
	        console.error('Error loading entity details:', error);
	        if (window.app && window.app.showAlert) {
	            window.app.showAlert('Error al cargar los datos: ' + error.message, 'danger');
	        }
	        setTimeout(() => {
	            window.location.href = 'list.html';
	        }, 2000);
	    }
	}
	
	// Función para mostrar los detalles de la entidad
	function displayEntityDetails(entity, relations) {
	    const primaryValue = entity['['/]'[entidad.atributos->select(a | a.isPrimaryKey)->first().nombre/]'] || 'N/A';
	    document.getElementById('entityTitle').textContent = '[entidad.nombre/] #' + primaryValue;
	    document.getElementById('recordId').textContent = primaryValue;
	    
	    [for (atrib : Atributo | entidad.atributos)]
	    const field_[atrib.nombre/] = document.getElementById('field_[atrib.nombre/]');
	    if (field_[atrib.nombre/]) {
	        const value = entity['['/]'[atrib.nombre/]'];
	        [if (atrib.tipo = TipoAtributo::BOOLEAN)]
	        field_[atrib.nombre/].innerHTML = (value === true || value === 'true') ? 
	            '<span class="badge badge-success">Sí</span>' : 
	            '<span class="badge badge-danger">No</span>';
	        [elseif (atrib.nombre.toLowerCase().contains('email'))]
	        field_[atrib.nombre/].innerHTML = value ? 
	            '<a href="mailto:' + value + '" class="link">' + value + '</a>' : 
	            '<span class="text-muted">-</span>';
	        [elseif (atrib.isPrimaryKey)]
	        field_[atrib.nombre/].innerHTML = '<span class="badge badge-primary">' + (value || 'N/A') + '</span>';
	        [else]
	        field_[atrib.nombre/].textContent = value || '-';
	        [/if]
	    }
	    [/for]
	    
	    document.getElementById('lastUpdated').textContent = new Date().toLocaleString('es-ES');
	}
	
	// Función para eliminar la entidad
	async function deleteEntity() {
	    const confirmBtn = document.getElementById('confirmDeleteBtn');
	    const originalText = confirmBtn.textContent;
	    
	    confirmBtn.disabled = true;
	    confirmBtn.innerHTML = '<span class="spinner"></span> Eliminando...';
	    
	    try {
	        const dataManager = new DataManager('[entidad.nombre.toLowerCase()/]');
	        const response = await dataManager.delete(currentEntityId);
	        
	        if (response && response.success) {
	            if (window.app && window.app.showAlert) {
	                window.app.showAlert('¡[entidad.nombre/] eliminado correctamente!', 'success');
	            }
	            closeDeleteModal();
	            setTimeout(() => {
	                window.location.href = 'list.html';
	            }, 1500);
	        } else {
	            if (window.app && window.app.showAlert) {
	                window.app.showAlert('Error al eliminar: ' + (response?.error || 'Error desconocido'), 'danger');
	            }
	            confirmBtn.disabled = false;
	            confirmBtn.textContent = originalText;
	        }
	    } catch (error) {
	        if (window.app && window.app.showAlert) {
	            window.app.showAlert('Error al eliminar: ' + error.message, 'danger');
	        }
	        confirmBtn.disabled = false;
	        confirmBtn.textContent = originalText;
	    }
	}
	
	// Otras funciones
	function confirmDelete() {
	    document.getElementById('deleteModal').style.display = 'flex';
	    document.getElementById('confirmDeleteBtn').onclick = function() {
	        deleteEntity();
	    };
	}
	
	function closeDeleteModal() {
	    document.getElementById('deleteModal').style.display = 'none';
	}
	
	function formatDate(dateString) {
	    if (!dateString) return '-';
	    const date = new Date(dateString);
	    return date.toLocaleDateString('es-ES', {
	        year: 'numeric',
	        month: 'long',
	        day: 'numeric'
	    });
	}
	
	// Inicializar la página
	document.addEventListener('DOMContentLoaded', function() {
	    const urlParams = new URLSearchParams(window.location.search);
	    currentEntityId = urlParams.get('id');
	    
	    if (!currentEntityId) {
	        if (window.app && window.app.showAlert) {
	            window.app.showAlert('ID de registro no proporcionado', 'danger');
	        }
	        setTimeout(() => {
	            window.location.href = 'list.html';
	        }, 2000);
	        return;
	    }
	    
	    document.getElementById('editLink').href = 'edit.html?id=' + currentEntityId;
	    loadEntityDetails();
	});
	
	window.onclick = function(event) {
	    const modal = document.getElementById('deleteModal');
	    if (event.target === modal) {
	        closeDeleteModal();
	    }
	};
	</script>
    
    <style>
        .loading-indicator {
            text-align: center;
            padding: 3rem;
            color: var(--gray-600);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary-600);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }
        
        .actions-info h2 {
            margin: 0 0 0.5rem;
            color: var(--gray-900);
        }
        
        .actions-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius);
            border-left: 3px solid var(--primary-500);
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .detail-value {
            color: var(--gray-900);
            font-size: 1rem;
            word-wrap: break-word;
        }
        
        .references-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .reference-item {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            background: var(--blue-50);
            border-radius: var(--radius);
            border-left: 3px solid var(--blue-500);
        }
        
        .reference-label {
            font-weight: 600;
            color: var(--blue-700);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .reference-value {
            color: var(--blue-900);
            font-size: 1rem;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .metadata-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--gray-100);
            border-radius: var(--radius);
        }
        
        .metadata-label {
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.875rem;
        }
        
        .metadata-value {
            color: var(--gray-900);
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .link {
            color: var(--primary-600);
            text-decoration: none;
        }
        
        .link:hover {
            color: var(--primary-700);
            text-decoration: underline;
        }
        
        .text-muted {
            color: var(--gray-500);
            font-style: italic;
        }
        
        .warning-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--warning-50);
            border: 1px solid var(--warning-200);
            border-radius: var(--radius);
            color: var(--warning-700);
            margin-top: 1rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 0;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            animation: modalSlide 0.3s ease;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 1.5rem 1.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .modal-header h4 {
            margin: 0;
            color: var(--gray-900);
        }
        
        .modal-body {
            padding: 1rem 1.5rem;
        }
        
        .modal-footer {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .actions-row {
                flex-direction: column;
                text-align: center;
            }
            
            .actions-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .actions-buttons .btn {
                width: 100%;
                justify-content: center;
            }
            
            .details-grid,
            .references-grid {
                grid-template-columns: 1fr;
            }
            
            .metadata-grid {
                grid-template-columns: 1fr;
            }
            
            .metadata-item {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</body>
</html>
[/file]
[/template]